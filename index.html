<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RANZZ STORE | V.164 FIXED</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@700;900&family=Outfit:wght@700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #000000; --card: #0d0d0d; --border: rgba(255,255,255,0.08);
            --accent: #007aff; --success: #00ff88; --danger: #ff3b30; --text: #ffffff;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Outfit', sans-serif; }
        body { background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; }
        
        #toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: var(--danger); color: white; padding: 12px 25px; border-radius: 50px; font-weight: 900; font-size: 12px; z-index: 20000; display: none; box-shadow: 0 10px 30px rgba(255,59,48,0.3); }

        header { padding: 25px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); }
        .money { font-family: 'Space Grotesk', sans-serif; color: var(--success); font-weight: 900; font-size: 20px; }

        .main-view { height: calc(100vh - 160px); overflow-y: auto; padding: 20px; padding-bottom: 120px; }
        .page { display: none; } .page.active { display: block; }

        .db-card { background: var(--card); border-radius: 25px; padding: 18px; border: 1px solid var(--border); margin-bottom: 15px; }
        .btn { background: var(--accent); color: white; border: none; padding: 18px; border-radius: 20px; font-weight: 900; width: 100%; cursor: pointer; margin-top: 10px; }
        .input-box { background: #161616; border: 1px solid var(--border); padding: 18px; border-radius: 18px; color: white; width: 100%; margin-bottom: 15px; outline: none; font-weight: 700; }

        nav { position: fixed; bottom: 25px; left: 20px; right: 20px; background: rgba(15,15,15,0.95); backdrop-filter: blur(20px); border: 1px solid var(--border); border-radius: 35px; display: flex; justify-content: space-around; padding: 18px; z-index: 1000; }
        .nav-item { font-size: 24px; cursor: pointer; opacity: 0.3; transition: 0.3s; }
        .nav-item.active { opacity: 1; color: var(--accent); transform: scale(1.1); }
        
        /* DATABASE TABLE STYLE */
        .db-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .db-table td { padding: 12px; border-bottom: 1px solid var(--border); font-size: 14px; }
    </style>
</head>
<body>

    <div id="toast"></div>

    <header>
        <div style="font-weight:900; font-size:22px;">RANZZ<span>STORE</span></div>
        <div class="money" id="main-balance">Rp 0</div>
    </header>

    <div class="main-view">
        <div id="p-home" class="page active">
            <h2 style="font-weight:900; margin-bottom:20px;">KATALOG üè†</h2>
            <div id="prod-list" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;"></div>
        </div>

        <div id="p-db" class="page">
            <h2 style="font-weight:900; margin-bottom:20px;">DATABASE MASTER üìä</h2>
            <div id="depo-requests"></div>
            <div class="db-card">
                <table class="db-table"><tbody id="user-body"></tbody></table>
            </div>
        </div>

        <div id="p-prof" class="page">
            <div id="auth-ui" style="text-align:center;">
                <h2 style="font-weight:900; margin-bottom:20px;">IDENTITY GATE</h2>
                <input type="text" id="l-user" class="input-box" placeholder="USERNAME">
                <input type="password" id="l-pass" class="input-box" placeholder="PASSWORD">
                <button class="btn" onclick="auth('LOGIN')">LOG IN</button>
                <button class="btn" style="background:transparent; border:1px solid var(--border)" onclick="auth('REG')">DAFTAR</button>
            </div>
            <div id="user-ui" style="display:none; text-align:center;">
                <div style="width:80px; height:80px; background:var(--accent); border-radius:20px; margin:0 auto 15px; display:flex; align-items:center; justify-content:center; font-size:30px;">üë§</div>
                <h2 id="hello-user" style="font-weight:900; margin-bottom:10px;">-</h2>
                <button class="btn" style="background:var(--danger)" onclick="logout()">LOGOUT</button>
            </div>
        </div>
    </div>

    <nav>
        <div class="nav-item active" onclick="nt('p-home', this)">üè†</div> 
        <div class="nav-item" onclick="handleDepoClick()">üí∏</div> 
        <div id="nav-admin-tools" style="display:contents;"></div> 
        <div class="nav-item" id="nav-prof-btn" onclick="nt('p-prof', this)">üë§</div> 
    </nav>

    <div id="m-depo" style="position:fixed; inset:0; background:rgba(0,0,0,0.95); display:none; align-items:center; justify-content:center; z-index:10000; padding:25px;">
        <div class="db-card" style="width:100%; max-width:400px; text-align:center;">
            <h3 style="margin-bottom:15px; font-weight:900;">ISI SALDO üí∏</h3>
            <div class="input-box" style="text-align:left; font-size:12px; background:rgba(0,122,255,0.1); border-color:var(--accent);">
                DANA: 08123456789 (RANZZ)<br>GOPAY: 08123456789 (RANZZ)
            </div>
            <input type="number" id="d-amt" class="input-box" placeholder="NOMINAL (MIN 10000)">
            <button class="btn" onclick="subDepo()">KONFIRMASI</button>
            <button class="btn" style="background:none" onclick="closeModal('m-depo')">KEMBALI</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, push, onValue, get, update, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const conf = { databaseURL: "https://flutter-ai-playground-e9460-default-rtdb.asia-southeast1.firebasedatabase.app" };
        const app = initializeApp(conf);
        const db = getDatabase(app);
        
        // Ganti kunci session agar fresh
        let user = JSON.parse(localStorage.getItem('ranzz_session_v164'));

        // --- AUTH SYSTEM FIXED ---
        window.auth = async (mode) => {
            const u = document.getElementById('l-user').value.trim();
            const p = document.getElementById('l-pass').value;
            if(!u || !p) return alert("ISI SEMUA KOLOM!");

            const uRef = ref(db, 'vortex_users/' + u);
            const snap = await get(uRef);

            if(mode === 'LOGIN') {
                if(snap.exists() && snap.val().password === p) {
                    localStorage.setItem('ranzz_session_v164', JSON.stringify(snap.val()));
                    alert("LOGIN BERHASIL!");
                    location.reload();
                } else {
                    alert("USER ATAU PASSWORD SALAH!");
                }
            } else {
                if(snap.exists()) return alert("USERNAME SUDAH ADA!");
                const newU = { username: u, password: p, balance: 0, role: u === "Ranzz_Own" ? "OWNER" : "MEMBER" };
                await set(uRef, newU);
                alert("DAFTAR SUKSES! SILAKAN LOGIN.");
            }
        };

        // --- SESSION RENDER ---
        if(user) {
            document.getElementById('auth-ui').style.display = 'none';
            document.getElementById('user-ui').style.display = 'block';
            document.getElementById('hello-user').innerText = user.username.toUpperCase();
            
            onValue(ref(db, `vortex_users/${user.username}/balance`), s => {
                document.getElementById('main-balance').innerText = "Rp " + (s.val() || 0).toLocaleString();
            });

            if(user.username === "Ranzz_Own") {
                document.getElementById('nav-admin-tools').innerHTML = `<div class="nav-item" onclick="nt('p-db', this)">üìä</div>`;
                initOwner();
            }
        }

        function initOwner() {
            onValue(ref(db, 'vortex_users'), s => {
                const b = document.getElementById('user-body'); b.innerHTML = "";
                s.forEach(u => {
                    const d = u.val();
                    b.innerHTML += `<tr><td><b>${d.username}</b></td><td style="text-align:right">Rp ${d.balance.toLocaleString()}</td></tr>`;
                });
            });
            onValue(ref(db, 'depo_requests'), s => {
                const dBox = document.getElementById('depo-requests'); dBox.innerHTML = "";
                s.forEach(r => {
                    const v = r.val();
                    dBox.innerHTML += `<div class="db-card" style="border-left:4px solid var(--success)">
                        ${v.username} Minta Rp ${v.amount.toLocaleString()} 
                        <button onclick="acc('${r.key}','${v.username}',${v.amount})" style="float:right; background:var(--success); border:none; padding:5px 10px; border-radius:10px; font-weight:900;">ACC</button>
                    </div>`;
                });
            });
        }

        window.acc = async (k, u, a) => {
            const r = ref(db, `vortex_users/${u}`);
            const s = await get(r);
            await update(r, { balance: (s.val().balance || 0) + a });
            await remove(ref(db, `depo_requests/${k}`));
            alert("BERHASIL ACC!");
        };

        // --- UI HELPERS ---
        window.nt = (id, el) => {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            el.classList.add('active');
        };
        window.handleDepoClick = () => {
            if(!user) {
                alert("LOGIN DULU BOS!");
                nt('p-prof', document.getElementById('nav-prof-btn'));
            } else document.getElementById('m-depo').style.display = 'flex';
        };
        window.subDepo = async () => {
            const a = parseInt(document.getElementById('d-amt').value);
            if(a < 10000 || isNaN(a)) return alert("MINIMAL 10.000!");
            await push(ref(db, 'depo_requests'), { username: user.username, amount: a });
            alert("REQ TERKIRIM!");
            document.getElementById('m-depo').style.display = 'none';
        };
        window.closeModal = (id) => document.getElementById(id).style.display = 'none';
        window.logout = () => { localStorage.clear(); location.reload(); };
    </script>
</body>
</html>
