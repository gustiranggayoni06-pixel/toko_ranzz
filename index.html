<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VORTEX V.116 | MASTER RANZZ</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #010204; --card: rgba(28,28,30,0.7); --border: rgba(255,255,255,0.1);
            --accent: #0a84ff; --gopay: #0081a0; --dana: #007aff; --text: #ffffff; --dim: #8e8e93; --success: #32d74b; --danger: #ff453a;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text); overflow: hidden; height: 100vh; }

        /* iOS Alert */
        #custom-alert { position: fixed; top: -100px; left: 50%; transform: translateX(-50%); background: rgba(44,44,46,0.95); backdrop-filter: blur(20px); padding: 12px 25px; border-radius: 25px; z-index: 10000; transition: 0.6s cubic-bezier(0.23, 1, 0.32, 1); border: 1px solid var(--border); display: flex; align-items: center; gap: 10px; font-weight: 600; box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
        #custom-alert.show { top: 25px; }

        /* Success Overlay */
        #success-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(1, 2, 4, 0.9); backdrop-filter: blur(15px); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 10000; animation: fadeIn 0.3s ease; }
        .check-icon { font-size: 80px; margin-bottom: 20px; transform: scale(0); animation: popIn 0.5s 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes popIn { to { transform: scale(1); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Premium Sheet */
        #add-panel { position: fixed; bottom: -100%; left: 0; width: 100%; background: #1c1c1e; z-index: 2000; border-radius: 35px 35px 0 0; padding: 25px; transition: 0.5s cubic-bezier(0.32, 0.72, 0, 1); border-top: 1px solid var(--border); box-shadow: 0 -10px 40px rgba(0,0,0,0.5); }
        .sheet-bar { width: 40px; height: 5px; background: #3a3a3c; border-radius: 10px; margin: 0 auto 20px; }

        /* Glass Upload UI */
        .upload-zone { width: 100%; height: 220px; background: rgba(255,255,255,0.03); border: 2px dashed rgba(255,255,255,0.1); border-radius: 25px; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; margin-bottom: 20px; transition: 0.3s; }
        #prev-prod { width: 100%; height: 100%; object-fit: cover; object-position: center; border-radius: 23px; display: none; position: absolute; top: 0; left: 0; z-index: 5; }
        .upload-label { text-align: center; color: var(--dim); font-weight: 600; z-index: 1; }

        header { padding: 20px; display: flex; justify-content: space-between; align-items: center; }
        .balance-chip { background: #1c1c1e; padding: 8px 18px; border-radius: 25px; font-weight: 800; color: var(--success); border: 1px solid var(--border); }

        .main-view { height: calc(100vh - 150px); overflow-y: auto; padding: 0 20px 100px; }
        .page { display: none; } .page.active { display: block; animation: fade 0.4s ease; }
        @keyframes fade { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Wallet Cards */
        .wallet-scroll { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 15px; scroll-snap-type: x mandatory; }
        .wallet-scroll::-webkit-scrollbar { display: none; }
        .pay-card { min-width: 85%; scroll-snap-align: center; border-radius: 28px; padding: 25px; position: relative; overflow: hidden; box-shadow: 0 15px 30px rgba(0,0,0,0.3); }
        .card-dana { background: linear-gradient(135deg, #007aff, #0056b3); }
        .card-gopay { background: linear-gradient(135deg, #0081a0, #005f73); }
        .pay-val { font-family: 'JetBrains Mono', monospace; font-size: 22px; margin: 12px 0; display: block; }

        .input-box { background: #2c2c2e; border: none; padding: 18px; border-radius: 18px; color: white; width: 100%; margin-bottom: 12px; outline: none; font-size: 16px; }
        .btn-ios { background: var(--accent); color: white; border: none; padding: 18px; border-radius: 18px; font-weight: 800; width: 100%; font-size: 16px; margin-top: 10px; box-shadow: 0 10px 20px rgba(10,132,255,0.3); }

        .card-modern { background: var(--card); border: 1px solid var(--border); border-radius: 24px; padding: 20px; margin-bottom: 15px; backdrop-filter: blur(15px); }
        .card-modern img { width: 100%; height: 130px; object-fit: cover; border-radius: 18px; margin-bottom: 10px; }

        nav { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(28,28,30,0.85); backdrop-filter: blur(30px); border-top: 0.5px solid var(--border); display: flex; justify-content: space-around; padding: 12px 10px 35px; z-index: 1000; }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; opacity: 0.3; transition: 0.3s; }
        .nav-item.active { opacity: 1; transform: scale(1.1); }
        .nav-icon { font-size: 24px; }
        
        .admin-only { display: none !important; }
        .is-admin .admin-only { display: block !important; }
    </style>
</head>
<body id="body-tag">

    <div id="success-overlay">
        <div class="check-icon">‚úÖ</div>
        <h2 style="font-weight: 800;">BERHASIL DIPOSTING!</h2>
        <p style="color: var(--dim); margin-top: 10px;">Produk sudah tayang di Shop üöÄ</p>
    </div>

    <div id="custom-alert">
        <span id="alert-icon">‚ö†Ô∏è</span> <span id="alert-msg">Pesan</span>
    </div>

    <div id="add-panel">
        <div class="sheet-bar"></div>
        <h3 style="margin-bottom:20px; text-align:center;">New Product üì∏</h3>
        
        <input type="file" id="file-prod" accept="image/*" onchange="previewImg(this)" style="display:none;">
        <div class="upload-zone" onclick="document.getElementById('file-prod').click()">
            <div class="upload-label" id="p-label">
                <span style="font-size:40px;">üñºÔ∏è</span><br>
                <span>Tap to Upload Photo</span>
            </div>
            <img id="prev-prod">
        </div>

        <input type="text" id="add-n" class="input-box" placeholder="Product Name">
        <input type="number" id="add-p" class="input-box" placeholder="Price (Rp)">
        <button class="btn-ios" id="btn-publish" onclick="uploadAndPush()">Post to Shop üöÄ</button>
        <button onclick="toggleAddPanel()" style="width:100%; background:none; border:none; color:var(--dim); margin-top:15px; font-weight:700;">Cancel</button>
    </div>

    <header>
        <div style="font-size:24px; font-weight:900; letter-spacing:-1px;">VORTEX</div>
        <div class="balance-chip" id="user-status">Rp 0</div>
    </header>

    <div class="main-view">
        <div id="p-home" class="page active">
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;" id="prod-list"></div>
        </div>

        <div id="p-topup" class="page">
            <div id="wallet-core" style="display:none;">
                <div class="wallet-scroll">
                    <div class="pay-card card-dana">
                        <p style="font-size:10px; font-weight:800; opacity:0.8;">E-WALLET DANA üîµ</p>
                        <span class="pay-val">081218002778</span>
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <span style="font-weight:700; font-size:13px;">S*****I</span>
                            <button onclick="copyNum('081218002778')" style="background:rgba(255,255,255,0.2); border:none; padding:8px 15px; border-radius:12px; color:white; font-size:10px; font-weight:800;">COPY üìã</button>
                        </div>
                    </div>
                    <div class="pay-card card-gopay">
                        <p style="font-size:10px; font-weight:800; opacity:0.8;">E-WALLET GOPAY üü¢</p>
                        <span class="pay-val">085718522934</span>
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <span style="font-weight:700; font-size:11px;">D***D R*****I R****N</span>
                            <button onclick="copyNum('085718522934')" style="background:rgba(255,255,255,0.2); border:none; padding:8px 15px; border-radius:12px; color:white; font-size:10px; font-weight:800;">COPY üìã</button>
                        </div>
                    </div>
                </div>

                <div class="card-modern" style="margin-top:20px;">
                    <p style="font-size:12px; color:var(--dim); margin-bottom:12px;">Minimal Top Up: <b>Rp 10.000</b></p>
                    <input type="number" id="in-topup" class="input-box" placeholder="Amount Rp...">
                    <button class="btn-ios" onclick="requestTopup()">Confirm Transfer üí∏</button>
                </div>
                <div class="admin-only" id="admin-area"></div>
            </div>
            <div id="wallet-gate" class="card-modern" style="text-align:center;">
                <h3>Wallet Locked üîí</h3>
                <button class="btn-ios" onclick="nt('p-prof')">Sign In</button>
            </div>
        </div>

        <div id="p-prof" class="page">
            <div id="auth-gate">
                <div class="card-modern">
                    <h2 style="margin-bottom:15px;">Access Account üîë</h2>
                    <input type="text" id="inp-u" class="input-box" placeholder="Username">
                    <input type="password" id="inp-p" class="input-box" placeholder="Password">
                    <button class="btn-ios" onclick="handleAuth('login')">Sign In üì•</button>
                    <button class="btn-ios" style="background:none; color:var(--accent);" onclick="handleAuth('register')">Register ‚ú®</button>
                </div>
            </div>
            <div id="profile-core" style="display:none;">
                <div class="card-modern" style="text-align:center;">
                    <div style="font-size:60px; margin-bottom:15px;">üë§</div>
                    <h2 id="disp-user">Username</h2>
                    <p id="disp-role" style="color:var(--dim); margin-bottom:20px;"></p>
                    <button class="btn-ios" style="background:var(--danger);" onclick="location.reload()">Log Out üö™</button>
                </div>
                <div class="admin-only" id="m-list" style="margin-top:20px;"></div>
            </div>
        </div>
    </div>

    <nav>
        <div class="nav-item active" onclick="nt('p-home', this)">
            <span class="nav-icon">üè†</span>
        </div>
        <div class="nav-item" onclick="nt('p-topup', this)">
            <span class="nav-icon">üíµ</span>
        </div>
        <div class="nav-item admin-only" onclick="toggleAddPanel()">
            <div style="background:var(--accent); width:45px; height:45px; border-radius:50%; display:flex; align-items:center; justify-content:center; color:white; font-size:22px; margin-top:-5px;">‚ûï</div>
        </div>
        <div class="nav-item" onclick="nt('p-prof', this)">
            <span class="nav-icon">üë§</span>
        </div>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, get, set, onValue, push, remove, runTransaction } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const IMGBB_KEY = "34f195861496a99264c7674143a75871";
        const cf = { databaseURL: "https://flutter-ai-playground-e9460-default-rtdb.asia-southeast1.firebasedatabase.app" };
        const app = initializeApp(cf); const db = getDatabase(app);
        let userLog = null;
        const f = (v) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 }).format(v);

        window.showAlert = (msg, icon = '‚ö†Ô∏è') => {
            const el = document.getElementById('custom-alert');
            document.getElementById('alert-msg').innerText = msg;
            document.getElementById('alert-icon').innerText = icon;
            el.classList.add('show');
            setTimeout(() => el.classList.remove('show'), 3000);
        };

        window.copyNum = (num) => {
            navigator.clipboard.writeText(num);
            showAlert("Berhasil Disalin! üìã", "‚úÖ");
        };

        window.handleAuth = async (mode) => {
            const u = document.getElementById('inp-u').value.trim(), p = document.getElementById('inp-p').value.trim();
            if(!u || !p) return showAlert("Lengkapi data! üìù");
            const r = ref(db, 'vortex_users/' + u); const s = await get(r);
            if(mode === 'register') {
                if(s.exists()) return showAlert("Username ada! ‚ùå");
                const uData = { username: u, password: p, balance: 0, role: (u === "Ranzz_Own" ? "OWNER" : "MEMBER") };
                await set(r, uData); applyLogin(uData);
            } else {
                if(!s.exists() || s.val().password !== p) return showAlert("Login Gagal! ‚ùå");
                applyLogin(s.val());
            }
        };

        function applyLogin(uData) {
            userLog = uData;
            document.getElementById('auth-gate').style.display = 'none';
            document.getElementById('profile-core').style.display = 'block';
            document.getElementById('wallet-gate').style.display = 'none';
            document.getElementById('wallet-core').style.display = 'block';
            document.getElementById('disp-user').innerText = userLog.username;
            document.getElementById('disp-role').innerText = "VORTEX " + userLog.role;
            if(userLog.role === "OWNER") { document.getElementById('body-tag').classList.add('is-admin'); loadAdmin(); }
            onValue(ref(db, `vortex_users/${userLog.username}/balance`), snap => {
                document.getElementById('user-status').innerText = f(snap.val() || 0);
            });
            nt('p-home', document.querySelector('.nav-item'));
        }

        window.requestTopup = async () => {
            const amt = parseInt(document.getElementById('in-topup').value);
            if(!amt || amt < 10000) return showAlert("Min Rp 10.000! üí∞");
            await push(ref(db, 'topup_tickets'), { uid: userLog.username, amount: amt });
            showAlert("Tiket Terkirim! ‚è≥", "üì©");
            document.getElementById('in-topup').value = '';
        };

        function loadAdmin() {
            onValue(ref(db, 'topup_tickets'), (s) => {
                const area = document.getElementById('admin-area');
                area.innerHTML = '<h4 style="margin:20px 0 10px;">Requests üì©</h4>';
                s.forEach(x => { const d = x.val();
                    area.innerHTML += `<div class="card-modern" style="display:flex; justify-content:space-between; align-items:center; padding:15px;">
                        <span><b>${d.uid}</b><br><small>${f(d.amount)}</small></span>
                        <button onclick="accTiket('${d.uid}', ${d.amount}, '${x.key}')" style="background:var(--success); border:none; color:white; padding:8px 15px; border-radius:12px; font-weight:800;">ACC ‚úÖ</button>
                    </div>`;
                });
            });
            onValue(ref(db, 'products'), (s) => {
                const mList = document.getElementById('m-list'); mList.innerHTML = '<h4 style="margin-bottom:15px;">Manage üóëÔ∏è</h4>';
                s.forEach(x => { const d = x.val();
                    mList.innerHTML += `<div class="card-modern" style="display:flex; justify-content:space-between; align-items:center; padding:12px 20px; margin-bottom:10px;">
                        <span>${d.name}</span>
                        <button onclick="delP('${x.key}')" style="background:none; border:none; font-size:22px;">üóëÔ∏è</button>
                    </div>`;
                });
            });
        }

        window.delP = async (k) => { if(confirm("Hapus Produk? üóëÔ∏è")) await remove(ref(db, 'products/' + k)); };

        window.accTiket = async (uid, amt, key) => {
            await runTransaction(ref(db, `vortex_users/${uid}/balance`), c => (c || 0) + amt);
            await remove(ref(db, 'topup_tickets/' + key));
            showAlert("Saldo Masuk! ‚úÖ", "üí∞");
        };

        window.previewImg = (input) => {
            const file = input.files[0]; if(!file) return;
            const reader = new FileReader(); 
            document.getElementById('p-label').innerHTML = "<span>Memproses...</span>";
            reader.onload = (e) => { 
                const prev = document.getElementById('prev-prod');
                prev.src = e.target.result;
                prev.style.display = 'block';
                document.getElementById('p-label').style.display = 'none';
            }; 
            reader.readAsDataURL(file);
        };

        window.uploadAndPush = async () => {
            const n = document.getElementById('add-n').value, p = document.getElementById('add-p').value, file = document.getElementById('file-prod').files[0];
            if(!n || !p || !file) return showAlert("Lengkapi data! üì¶");
            const btn = document.getElementById('btn-publish'); 
            btn.innerText = "Mengirim... ‚òÅÔ∏è"; 
            btn.disabled = true;
            const fd = new FormData(); 
            fd.append("image", file);
            try {
                const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, { method: "POST", body: fd });
                const data = await res.json();
                await push(ref(db, 'products'), { name: n, price: parseInt(p), img: data.data.url });
                toggleAddPanel();
                const overlay = document.getElementById('success-overlay');
                overlay.style.display = 'flex';
                document.getElementById('add-n').value = '';
                document.getElementById('add-p').value = '';
                document.getElementById('file-prod').value = '';
                document.getElementById('prev-prod').style.display = 'none';
                document.getElementById('p-label').style.display = 'block';
                document.getElementById('p-label').innerHTML = '<span style="font-size:40px;">üñºÔ∏è</span><br><span>Tap to Upload Photo</span>';
                setTimeout(() => { overlay.style.display = 'none'; }, 2000);
            } catch(e) { showAlert("Gagal! ‚ùå"); }
            btn.innerText = "Post to Shop üöÄ"; btn.disabled = false;
        };

        window.toggleAddPanel = () => {
            const p = document.getElementById('add-panel');
            p.style.bottom = p.style.bottom === '0px' ? '-100%' : '0px';
        };

        window.nt = (id, el) => {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(el) { document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active')); el.classList.add('active'); }
        };

        onValue(ref(db, 'products'), (s) => {
            const l = document.getElementById('prod-list'); l.innerHTML = '';
            s.forEach(x => { const d = x.val();
                l.innerHTML += `<div class="card-modern" style="padding:10px; margin-bottom:0;">
                    <img src="${d.img}">
                    <b style="font-size:13px; display:block; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${d.name}</b>
                    <span style="color:var(--accent); font-weight:800; font-size:12px;">${f(d.price)}</span>
                </div>`;
            });
        });
    </script>
</body>
</html>
